From 38abda86577fbe241b70609af14c29bd58993b8b Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Mon, 7 Jun 2021 19:08:42 +0800
Subject: [PATCH 52/78] Revert "drm/amd/display: Fix UBSAN: shift-out-of-bounds
 warning"

This reverts commit 081cec78467f7d3166432f3529d279dc6db233c2.
---
 .../dc/dml/dcn20/display_rq_dlg_calc_20.c     | 28 ++++---------------
 .../dc/dml/dcn20/display_rq_dlg_calc_20v2.c   | 28 ++++---------------
 .../dc/dml/dcn21/display_rq_dlg_calc_21.c     | 28 ++++---------------
 .../dc/dml/dcn30/display_rq_dlg_calc_30.c     | 28 ++++---------------
 .../display/dc/dml/dml1_display_rq_dlg_calc.c | 28 ++++---------------
 5 files changed, 25 insertions(+), 115 deletions(-)

diff --git a/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_rq_dlg_calc_20.c b/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_rq_dlg_calc_20.c
index 799bae229e67..72423dc425dc 100644
--- a/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_rq_dlg_calc_20.c
+++ b/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_rq_dlg_calc_20.c
@@ -293,31 +293,13 @@ static void handle_det_buf_split(struct display_mode_lib *mode_lib,
 	if (surf_linear) {
 		log2_swath_height_l = 0;
 		log2_swath_height_c = 0;
+	} else if (!surf_vert) {
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_height) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_height) - req128_c;
 	} else {
-		unsigned int swath_height_l;
-		unsigned int swath_height_c;
-
-		if (!surf_vert) {
-			swath_height_l = rq_param->misc.rq_l.blk256_height;
-			swath_height_c = rq_param->misc.rq_c.blk256_height;
-		} else {
-			swath_height_l = rq_param->misc.rq_l.blk256_width;
-			swath_height_c = rq_param->misc.rq_c.blk256_width;
-		}
-
-		if (swath_height_l > 0)
-			log2_swath_height_l = dml_log2(swath_height_l);
-
-		if (req128_l && log2_swath_height_l > 0)
-			log2_swath_height_l -= 1;
-
-		if (swath_height_c > 0)
-			log2_swath_height_c = dml_log2(swath_height_c);
-
-		if (req128_c && log2_swath_height_c > 0)
-			log2_swath_height_c -= 1;
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_width) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_width) - req128_c;
 	}
-
 	rq_param->dlg.rq_l.swath_height = 1 << log2_swath_height_l;
 	rq_param->dlg.rq_c.swath_height = 1 << log2_swath_height_c;
 
diff --git a/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_rq_dlg_calc_20v2.c b/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_rq_dlg_calc_20v2.c
index 6a6d5970d1d5..9c78446c3a9d 100644
--- a/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_rq_dlg_calc_20v2.c
+++ b/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_rq_dlg_calc_20v2.c
@@ -293,31 +293,13 @@ static void handle_det_buf_split(struct display_mode_lib *mode_lib,
 	if (surf_linear) {
 		log2_swath_height_l = 0;
 		log2_swath_height_c = 0;
+	} else if (!surf_vert) {
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_height) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_height) - req128_c;
 	} else {
-		unsigned int swath_height_l;
-		unsigned int swath_height_c;
-
-		if (!surf_vert) {
-			swath_height_l = rq_param->misc.rq_l.blk256_height;
-			swath_height_c = rq_param->misc.rq_c.blk256_height;
-		} else {
-			swath_height_l = rq_param->misc.rq_l.blk256_width;
-			swath_height_c = rq_param->misc.rq_c.blk256_width;
-		}
-
-		if (swath_height_l > 0)
-			log2_swath_height_l = dml_log2(swath_height_l);
-
-		if (req128_l && log2_swath_height_l > 0)
-			log2_swath_height_l -= 1;
-
-		if (swath_height_c > 0)
-			log2_swath_height_c = dml_log2(swath_height_c);
-
-		if (req128_c && log2_swath_height_c > 0)
-			log2_swath_height_c -= 1;
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_width) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_width) - req128_c;
 	}
-
 	rq_param->dlg.rq_l.swath_height = 1 << log2_swath_height_l;
 	rq_param->dlg.rq_c.swath_height = 1 << log2_swath_height_c;
 
diff --git a/drivers/gpu/drm/amd/display/dc/dml/dcn21/display_rq_dlg_calc_21.c b/drivers/gpu/drm/amd/display/dc/dml/dcn21/display_rq_dlg_calc_21.c
index dc1c81a6e377..edd41d358291 100644
--- a/drivers/gpu/drm/amd/display/dc/dml/dcn21/display_rq_dlg_calc_21.c
+++ b/drivers/gpu/drm/amd/display/dc/dml/dcn21/display_rq_dlg_calc_21.c
@@ -277,31 +277,13 @@ static void handle_det_buf_split(
 	if (surf_linear) {
 		log2_swath_height_l = 0;
 		log2_swath_height_c = 0;
+	} else if (!surf_vert) {
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_height) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_height) - req128_c;
 	} else {
-		unsigned int swath_height_l;
-		unsigned int swath_height_c;
-
-		if (!surf_vert) {
-			swath_height_l = rq_param->misc.rq_l.blk256_height;
-			swath_height_c = rq_param->misc.rq_c.blk256_height;
-		} else {
-			swath_height_l = rq_param->misc.rq_l.blk256_width;
-			swath_height_c = rq_param->misc.rq_c.blk256_width;
-		}
-
-		if (swath_height_l > 0)
-			log2_swath_height_l = dml_log2(swath_height_l);
-
-		if (req128_l && log2_swath_height_l > 0)
-			log2_swath_height_l -= 1;
-
-		if (swath_height_c > 0)
-			log2_swath_height_c = dml_log2(swath_height_c);
-
-		if (req128_c && log2_swath_height_c > 0)
-			log2_swath_height_c -= 1;
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_width) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_width) - req128_c;
 	}
-
 	rq_param->dlg.rq_l.swath_height = 1 << log2_swath_height_l;
 	rq_param->dlg.rq_c.swath_height = 1 << log2_swath_height_c;
 
diff --git a/drivers/gpu/drm/amd/display/dc/dml/dcn30/display_rq_dlg_calc_30.c b/drivers/gpu/drm/amd/display/dc/dml/dcn30/display_rq_dlg_calc_30.c
index 58c312f80a07..416bf6fb67bd 100644
--- a/drivers/gpu/drm/amd/display/dc/dml/dcn30/display_rq_dlg_calc_30.c
+++ b/drivers/gpu/drm/amd/display/dc/dml/dcn30/display_rq_dlg_calc_30.c
@@ -237,31 +237,13 @@ static void handle_det_buf_split(struct display_mode_lib *mode_lib,
 	if (surf_linear) {
 		log2_swath_height_l = 0;
 		log2_swath_height_c = 0;
+	} else if (!surf_vert) {
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_height) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_height) - req128_c;
 	} else {
-		unsigned int swath_height_l;
-		unsigned int swath_height_c;
-
-		if (!surf_vert) {
-			swath_height_l = rq_param->misc.rq_l.blk256_height;
-			swath_height_c = rq_param->misc.rq_c.blk256_height;
-		} else {
-			swath_height_l = rq_param->misc.rq_l.blk256_width;
-			swath_height_c = rq_param->misc.rq_c.blk256_width;
-		}
-
-		if (swath_height_l > 0)
-			log2_swath_height_l = dml_log2(swath_height_l);
-
-		if (req128_l && log2_swath_height_l > 0)
-			log2_swath_height_l -= 1;
-
-		if (swath_height_c > 0)
-			log2_swath_height_c = dml_log2(swath_height_c);
-
-		if (req128_c && log2_swath_height_c > 0)
-			log2_swath_height_c -= 1;
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_width) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_width) - req128_c;
 	}
-
 	rq_param->dlg.rq_l.swath_height = 1 << log2_swath_height_l;
 	rq_param->dlg.rq_c.swath_height = 1 << log2_swath_height_c;
 
diff --git a/drivers/gpu/drm/amd/display/dc/dml/dml1_display_rq_dlg_calc.c b/drivers/gpu/drm/amd/display/dc/dml/dml1_display_rq_dlg_calc.c
index 414da64f5734..4c3e9cc30167 100644
--- a/drivers/gpu/drm/amd/display/dc/dml/dml1_display_rq_dlg_calc.c
+++ b/drivers/gpu/drm/amd/display/dc/dml/dml1_display_rq_dlg_calc.c
@@ -344,31 +344,13 @@ static void handle_det_buf_split(
 	if (surf_linear) {
 		log2_swath_height_l = 0;
 		log2_swath_height_c = 0;
+	} else if (!surf_vert) {
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_height) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_height) - req128_c;
 	} else {
-		unsigned int swath_height_l;
-		unsigned int swath_height_c;
-
-		if (!surf_vert) {
-			swath_height_l = rq_param->misc.rq_l.blk256_height;
-			swath_height_c = rq_param->misc.rq_c.blk256_height;
-		} else {
-			swath_height_l = rq_param->misc.rq_l.blk256_width;
-			swath_height_c = rq_param->misc.rq_c.blk256_width;
-		}
-
-		if (swath_height_l > 0)
-			log2_swath_height_l = dml_log2(swath_height_l);
-
-		if (req128_l && log2_swath_height_l > 0)
-			log2_swath_height_l -= 1;
-
-		if (swath_height_c > 0)
-			log2_swath_height_c = dml_log2(swath_height_c);
-
-		if (req128_c && log2_swath_height_c > 0)
-			log2_swath_height_c -= 1;
+		log2_swath_height_l = dml_log2(rq_param->misc.rq_l.blk256_width) - req128_l;
+		log2_swath_height_c = dml_log2(rq_param->misc.rq_c.blk256_width) - req128_c;
 	}
-
 	rq_param->dlg.rq_l.swath_height = 1 << log2_swath_height_l;
 	rq_param->dlg.rq_c.swath_height = 1 << log2_swath_height_c;
 
-- 
2.25.1

