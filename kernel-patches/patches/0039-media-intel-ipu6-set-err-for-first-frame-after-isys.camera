From 888923b41c3b97c0db89e3645dd6efab245331c7 Mon Sep 17 00:00:00 2001
From: zouxiaoh <xiaohong.zou@intel.com>
Date: Tue, 12 Apr 2022 14:34:10 +0800
Subject: [PATCH 39/40] media: intel-ipu6: set err for first frame after isys
 reset

when stream on, first frame may broken, set V4L2 error flag.

Signed-off-by: Chen Meng J <meng.j.chen@intel.com>
Signed-off-by: zouxiaoh <xiaohong.zou@intel.com>
---
 drivers/media/pci/intel/ipu-isys-queue.c | 4 ++++
 drivers/media/pci/intel/ipu-isys-queue.h | 1 +
 drivers/media/pci/intel/ipu-isys-video.c | 1 +
 drivers/media/pci/intel/ipu-isys-video.h | 1 +
 4 files changed, 7 insertions(+)

diff --git a/drivers/media/pci/intel/ipu-isys-queue.c b/drivers/media/pci/intel/ipu-isys-queue.c
index 43807a85ed78..b0e990463df0 100644
--- a/drivers/media/pci/intel/ipu-isys-queue.c
+++ b/drivers/media/pci/intel/ipu-isys-queue.c
@@ -887,6 +887,7 @@ static int reset_start_streaming(struct ipu_isys_video *av)
 	}
 	spin_unlock_irqrestore(&aq->lock, flags);
 
+	av->skipframe = 1;
 	rval = __start_streaming(&aq->vbq, 0);
 
 	return rval;
@@ -1195,6 +1196,9 @@ void ipu_isys_queue_buf_done(struct ipu_isys_buffer *ib)
 		 * to the userspace when it is de-queued
 		 */
 		atomic_set(&ib->str2mmio_flag, 0);
+	} else if (atomic_read(&ib->skipframe_flag)) {
+		vb2_buffer_done(vb, VB2_BUF_STATE_ERROR);
+		atomic_set(&ib->skipframe_flag, 0);
 	} else {
 		vb2_buffer_done(vb, VB2_BUF_STATE_DONE);
 	}
diff --git a/drivers/media/pci/intel/ipu-isys-queue.h b/drivers/media/pci/intel/ipu-isys-queue.h
index 99be2989a088..ed14b6b23a34 100644
--- a/drivers/media/pci/intel/ipu-isys-queue.h
+++ b/drivers/media/pci/intel/ipu-isys-queue.h
@@ -49,6 +49,7 @@ struct ipu_isys_buffer {
 	struct list_head req_head;
 	struct media_device_request *req;
 	atomic_t str2mmio_flag;
+	atomic_t skipframe_flag;
 };
 
 struct ipu_isys_video_buffer {
diff --git a/drivers/media/pci/intel/ipu-isys-video.c b/drivers/media/pci/intel/ipu-isys-video.c
index 86f7fa39ce0e..1b8999fbee34 100644
--- a/drivers/media/pci/intel/ipu-isys-video.c
+++ b/drivers/media/pci/intel/ipu-isys-video.c
@@ -1795,6 +1795,7 @@ int ipu_isys_video_init(struct ipu_isys_video *av,
 	av->ip.stream_id = 0;
 	av->ip.vc = 0;
 	av->reset = false;
+	av->skipframe = 0;
 
 #if defined(IPU_IWAKE_ENABLE)
 	if (!av->watermark) {
diff --git a/drivers/media/pci/intel/ipu-isys-video.h b/drivers/media/pci/intel/ipu-isys-video.h
index 46b812e3399e..f9e9b8e70f95 100644
--- a/drivers/media/pci/intel/ipu-isys-video.h
+++ b/drivers/media/pci/intel/ipu-isys-video.h
@@ -125,6 +125,7 @@ struct ipu_isys_video {
 	struct ipu_isys_pipeline ip;
 	unsigned int streaming;
 	unsigned int reset;
+	unsigned int skipframe;
 	bool packed;
 #if defined(IPU_ISYS_COMPRESSION)
 	bool compression;
-- 
2.25.1

