From 5e49b9706c12c94cdc885dbdf859d2b818ba2e19 Mon Sep 17 00:00:00 2001
From: Anshuman Gupta <anshuman.gupta@intel.com>
Date: Fri, 28 Apr 2023 12:56:47 +0530
Subject: [PATCH 684/704] i915: drm/i915/debug: dump_stack() on fw ack/clear
 timedout

During system wide resume it has been noticed that i915 is trying
grab/release a forcewake during noirq resume phase and timed out
for forcewake clear with forcewake ack register value 0xffffffff.

i915 does not have any noirq resume callback so seems like during
suspend, it has missed to disable some interrupt and causing this
issue.

Therefore temporary trigger dump_stack(), when forcewake results
error and taints CI.

Working

Signed-off-by: Anshuman Gupta <anshuman.gupta@intel.com>
---
 drivers/gpu/drm/i915/intel_uncore.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/gpu/drm/i915/intel_uncore.c b/drivers/gpu/drm/i915/intel_uncore.c
index 3470bfffea09..5c750b3f28b8 100644
--- a/drivers/gpu/drm/i915/intel_uncore.c
+++ b/drivers/gpu/drm/i915/intel_uncore.c
@@ -189,6 +189,7 @@ fw_domain_wait_ack_clear(const struct intel_uncore_forcewake_domain *d)
 			"%s: timed out waiting for forcewake ack to clear.\n",
 			intel_uncore_forcewake_domain_to_str(d->id));
 
+	dump_stack();
 	add_taint_for_CI(d->uncore->i915, TAINT_WARN); /* CI now unreliable */
 }
 
@@ -267,6 +268,7 @@ fw_domain_wait_ack_set(const struct intel_uncore_forcewake_domain *d)
 		drm_err(&d->uncore->i915->drm,
 			"%s: timed out waiting for forcewake ack request.\n",
 			intel_uncore_forcewake_domain_to_str(d->id));
+		dump_stack();
 		add_taint_for_CI(d->uncore->i915, TAINT_WARN); /* CI now unreliable */
 	}
 }
-- 
2.25.1

