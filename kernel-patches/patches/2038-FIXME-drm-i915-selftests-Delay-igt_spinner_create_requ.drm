From 41f11afb67e9c7b37266339ab47201131b8298c5 Mon Sep 17 00:00:00 2001
From: Jonathan Cavitt <jonathan.cavitt@intel.com>
Date: Wed, 28 Jun 2023 14:52:14 -0700
Subject: [PATCH 2038/2071] FIXME: drm/i915/selftests: Delay
 igt_spinner_create_request

Insert an arbitrary delay between MI_BATCH_BUFFER_STARTs
to afford HW the chance to interrupt the Command Parser.

FIXME: This is done to fix an MTL BCS0 reset failure.
Investigate this more thoroughly later to see if this
is truly necessary.

Signed-off-by: Jonathan Cavitt <jonathan.cavitt@intel.com>
Suggested-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Reviewed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Acked-by: Nirmoy Das <nirmoy.das@intel.com>
Reviewed-by: Andi Shyti <andi.shyti@linux.intel.com>
---
 drivers/gpu/drm/i915/selftests/igt_spinner.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/drivers/gpu/drm/i915/selftests/igt_spinner.c b/drivers/gpu/drm/i915/selftests/igt_spinner.c
index 618d9386d554..92a5a6778106 100644
--- a/drivers/gpu/drm/i915/selftests/igt_spinner.c
+++ b/drivers/gpu/drm/i915/selftests/igt_spinner.c
@@ -179,6 +179,16 @@ igt_spinner_create_request(struct igt_spinner *spin,
 
 	*batch++ = arbitration_command;
 
+	/*
+	 * Insert an arbitrary delay between MI_BATCH_BUFFER_STARTs to afford HW
+	 * the chance to interrupt the Command Parser
+	 *
+	 * Caveats:
+	 * - mtl bcs0 fails to reset if there is no MI_NOOP between MI_BB_START.
+	 */
+	memset32(batch, MI_NOOP, 128);
+	batch += 128;
+
 	if (GRAPHICS_VER(rq->engine->i915) >= 8)
 		*batch++ = MI_BATCH_BUFFER_START | BIT(8) | 1;
 	else if (IS_HASWELL(rq->engine->i915))
-- 
2.25.1

