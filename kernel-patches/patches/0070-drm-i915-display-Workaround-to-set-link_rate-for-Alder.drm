From 2c964042e5c2b0ea6144feb1c380316380f2b97c Mon Sep 17 00:00:00 2001
From: "Sodhi, Vunny" <vunny.sodhi@intel.com>
Date: Fri, 10 Sep 2021 19:12:16 +0800
Subject: [PATCH 70/72] drm/i915/display: Workaround to set link_rate for
 Alderlake

To support 8K@60, DP link training should happen 810000 which is
currently limited to 54MHz, so temporary returning hardcoded value
to unblock 8K@60 use case.

Signed-off-by: Sodhi, Vunny <vunny.sodhi@intel.com>
---
 drivers/gpu/drm/i915/display/intel_bios.c | 5 +++++
 drivers/gpu/drm/i915/display/intel_dp.c   | 4 ++++
 2 files changed, 9 insertions(+)

diff --git a/drivers/gpu/drm/i915/display/intel_bios.c b/drivers/gpu/drm/i915/display/intel_bios.c
index e86e6ed2d3bf..4d20ea65b538 100644
--- a/drivers/gpu/drm/i915/display/intel_bios.c
+++ b/drivers/gpu/drm/i915/display/intel_bios.c
@@ -2005,6 +2005,11 @@ static void parse_ddi_port(struct drm_i915_private *i915,
 		else
 			info->dp_max_link_rate = parse_bdb_216_dp_max_link_rate(child->dp_max_link_rate);
 
+
+		// TODO: Need to remove hardcoding of link_rate once VBT parsing is fixed
+		if (IS_ALDERLAKE_S(i915) || IS_ALDERLAKE_P(i915))
+				info->dp_max_link_rate = 810000;
+
 		drm_dbg_kms(&i915->drm,
 			    "Port %c VBT DP max link rate: %d\n",
 			    port_name(port), info->dp_max_link_rate);
diff --git a/drivers/gpu/drm/i915/display/intel_dp.c b/drivers/gpu/drm/i915/display/intel_dp.c
index 75d4ebc66941..4241022656e6 100644
--- a/drivers/gpu/drm/i915/display/intel_dp.c
+++ b/drivers/gpu/drm/i915/display/intel_dp.c
@@ -228,6 +228,10 @@ static int icl_max_source_rate(struct intel_dp *intel_dp)
 	struct drm_i915_private *dev_priv = to_i915(dig_port->base.base.dev);
 	enum phy phy = intel_port_to_phy(dev_priv, dig_port->base.port);
 
+	//To support 8K@60 using DP port max rate need to be set as 810000
+	if (IS_ALDERLAKE_S(dev_priv) || IS_ALDERLAKE_P(dev_priv))
+		return 810000;
+
 	if (intel_phy_is_combo(dev_priv, phy) &&
 	    !intel_dp_is_edp(intel_dp))
 		return 540000;
-- 
2.27.0

