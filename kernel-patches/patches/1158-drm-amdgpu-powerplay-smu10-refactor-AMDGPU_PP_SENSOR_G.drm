From 161708e4329af77e9a1bbaffabca6652429a88fa Mon Sep 17 00:00:00 2001
From: Shirish S <shirish.s@amd.com>
Date: Fri, 19 Mar 2021 12:28:40 +0530
Subject: [PATCH 1158/2740] drm/amdgpu/powerplay/smu10: refactor
 AMDGPU_PP_SENSOR_GPU_LOAD

refactor AMDGPU_PP_SENSOR_GPU_LOAD to ensure code consistency with other
commands

Signed-off-by: Shirish S <shirish.s@amd.com>
Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
---
 .../gpu/drm/amd/pm/powerplay/hwmgr/smu10_hwmgr.c    | 13 ++++++-------
 1 file changed, 6 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/amd/pm/powerplay/hwmgr/smu10_hwmgr.c b/drivers/gpu/drm/amd/pm/powerplay/hwmgr/smu10_hwmgr.c
index f5d59fa3a030..f5fe540cd536 100644
--- a/drivers/gpu/drm/amd/pm/powerplay/hwmgr/smu10_hwmgr.c
+++ b/drivers/gpu/drm/amd/pm/powerplay/hwmgr/smu10_hwmgr.c
@@ -1297,19 +1297,18 @@ static int smu10_read_sensor(struct pp_hwmgr *hwmgr, int idx,
 		*size = 4;
 		break;
 	case AMDGPU_PP_SENSOR_GPU_LOAD:
-		if (has_gfx_busy) {
+		if (!has_gfx_busy)
+			ret = -EOPNOTSUPP;
+		else {
 			ret = smum_send_msg_to_smc(hwmgr,
 						   PPSMC_MSG_GetGfxBusy,
 						   &activity_percent);
 			if (!ret)
-				activity_percent = activity_percent > 100 ? 100 : activity_percent;
+				*((uint32_t *)value) = min(activity_percent, (u32)100);
 			else
-				return -EIO;
-			*((uint32_t *)value) = activity_percent;
-			return 0;
-		} else {
-			return -EOPNOTSUPP;
+				ret = -EIO;
 		}
+		break;
 	default:
 		ret = -EOPNOTSUPP;
 		break;
-- 
2.25.1

