From 69c20a12556e4929fedbf81d9e7ebcf93288d9e4 Mon Sep 17 00:00:00 2001
From: Umesh Nerlige Ramappa <umesh.nerlige.ramappa@intel.com>
Date: Fri, 19 Nov 2021 17:42:01 -0800
Subject: [PATCH 875/888] drm/i915/pmu: Avoid with_intel_runtime_pm within
 spinlock

When guc timestamp ping worker runs it takes the spinlock and calls
with_intel_runtime_pm.  Since with_intel_runtime_pm may sleep, move the
spinlock inside __update_guc_busyness_stats.

Signed-off-by: Umesh Nerlige Ramappa <umesh.nerlige.ramappa@intel.com>
Reviewed-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20211120014201.26480-1-umesh.nerlige.ramappa@intel.com
---
 drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c | 12 +++---------
 1 file changed, 3 insertions(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c b/drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c
index f86d81dab156..eb21c39a0e7d 100644
--- a/drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c
+++ b/drivers/gpu/drm/i915/gt/uc/intel_guc_submission.c
@@ -1250,12 +1250,15 @@ static void __update_guc_busyness_stats(struct intel_guc *guc)
 	struct intel_gt *gt = guc_to_gt(guc);
 	struct intel_engine_cs *engine;
 	enum intel_engine_id id;
+	unsigned long flags;
 	ktime_t unused;
 
+	spin_lock_irqsave(&guc->timestamp.lock, flags);
 	for_each_engine(engine, gt, id) {
 		guc_update_pm_timestamp(guc, engine, &unused);
 		guc_update_engine_gt_clks(engine);
 	}
+	spin_unlock_irqrestore(&guc->timestamp.lock, flags);
 }
 
 static void guc_timestamp_ping(struct work_struct *wrk)
@@ -1265,7 +1268,6 @@ static void guc_timestamp_ping(struct work_struct *wrk)
 	struct intel_uc *uc = container_of(guc, typeof(*uc), guc);
 	struct intel_gt *gt = guc_to_gt(guc);
 	intel_wakeref_t wakeref;
-	unsigned long flags;
 	int srcu, ret;
 
 	/*
@@ -1276,13 +1278,9 @@ static void guc_timestamp_ping(struct work_struct *wrk)
 	if (ret)
 		return;
 
-	spin_lock_irqsave(&guc->timestamp.lock, flags);
-
 	with_intel_runtime_pm(&gt->i915->runtime_pm, wakeref)
 		__update_guc_busyness_stats(guc);
 
-	spin_unlock_irqrestore(&guc->timestamp.lock, flags);
-
 	intel_gt_reset_unlock(gt, srcu);
 
 	mod_delayed_work(system_highpri_wq, &guc->timestamp.work,
@@ -1321,16 +1319,12 @@ static void guc_init_engine_stats(struct intel_guc *guc)
 void intel_guc_busyness_park(struct intel_gt *gt)
 {
 	struct intel_guc *guc = &gt->uc.guc;
-	unsigned long flags;
 
 	if (!guc_submission_initialized(guc))
 		return;
 
 	cancel_delayed_work(&guc->timestamp.work);
-
-	spin_lock_irqsave(&guc->timestamp.lock, flags);
 	__update_guc_busyness_stats(guc);
-	spin_unlock_irqrestore(&guc->timestamp.lock, flags);
 }
 
 void intel_guc_busyness_unpark(struct intel_gt *gt)
-- 
2.25.1

