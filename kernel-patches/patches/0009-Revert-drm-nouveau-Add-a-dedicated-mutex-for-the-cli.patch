From c35037763ccd1c824aa4ef09812e500c57b5e750 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Tue, 7 Dec 2021 01:20:57 +0800
Subject: [PATCH 09/33] Revert "drm/nouveau: Add a dedicated mutex for the
 clients list"

This reverts commit 9221aff33edb627ea52a51379862f46e63e7c0c9.
---
 drivers/gpu/drm/nouveau/nouveau_drm.c | 10 ++++------
 drivers/gpu/drm/nouveau/nouveau_drv.h |  5 -----
 2 files changed, 4 insertions(+), 11 deletions(-)

diff --git a/drivers/gpu/drm/nouveau/nouveau_drm.c b/drivers/gpu/drm/nouveau/nouveau_drm.c
index 89f72b91c8c6..42fc5c813a9b 100644
--- a/drivers/gpu/drm/nouveau/nouveau_drm.c
+++ b/drivers/gpu/drm/nouveau/nouveau_drm.c
@@ -557,7 +557,6 @@ nouveau_drm_device_init(struct drm_device *dev)
 		nvkm_dbgopt(nouveau_debug, "DRM");
 
 	INIT_LIST_HEAD(&drm->clients);
-	mutex_init(&drm->clients_lock);
 	spin_lock_init(&drm->tile.lock);
 
 	/* workaround an odd issue on nvc1 by disabling the device's
@@ -655,7 +654,6 @@ nouveau_drm_device_fini(struct drm_device *dev)
 	nouveau_cli_fini(&drm->client);
 	nouveau_cli_fini(&drm->master);
 	nvif_parent_dtor(&drm->parent);
-	mutex_destroy(&drm->clients_lock);
 	kfree(drm);
 }
 
@@ -1088,9 +1086,9 @@ nouveau_drm_open(struct drm_device *dev, struct drm_file *fpriv)
 
 	fpriv->driver_priv = cli;
 
-	mutex_lock(&drm->clients_lock);
+	mutex_lock(&drm->client.mutex);
 	list_add(&cli->head, &drm->clients);
-	mutex_unlock(&drm->clients_lock);
+	mutex_unlock(&drm->client.mutex);
 
 done:
 	if (ret && cli) {
@@ -1116,9 +1114,9 @@ nouveau_drm_postclose(struct drm_device *dev, struct drm_file *fpriv)
 		nouveau_abi16_fini(cli->abi16);
 	mutex_unlock(&cli->mutex);
 
-	mutex_lock(&drm->clients_lock);
+	mutex_lock(&drm->client.mutex);
 	list_del(&cli->head);
-	mutex_unlock(&drm->clients_lock);
+	mutex_unlock(&drm->client.mutex);
 
 	nouveau_cli_fini(cli);
 	kfree(cli);
diff --git a/drivers/gpu/drm/nouveau/nouveau_drv.h b/drivers/gpu/drm/nouveau/nouveau_drv.h
index 8b252dca0fc3..b8025507a9e4 100644
--- a/drivers/gpu/drm/nouveau/nouveau_drv.h
+++ b/drivers/gpu/drm/nouveau/nouveau_drv.h
@@ -142,11 +142,6 @@ struct nouveau_drm {
 
 	struct list_head clients;
 
-	/**
-	 * @clients_lock: Protects access to the @clients list of &struct nouveau_cli.
-	 */
-	struct mutex clients_lock;
-
 	u8 old_pm_cap;
 
 	struct {
-- 
2.27.0

