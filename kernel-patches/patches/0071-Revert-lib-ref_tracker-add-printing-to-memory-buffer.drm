From 219e197c78af5182e4b0b21a2e341980878b8c51 Mon Sep 17 00:00:00 2001
From: Junxiao Chang <junxiao.chang@intel.com>
Date: Thu, 6 Jul 2023 15:04:16 +0800
Subject: [PATCH 0071/2351] Revert "lib/ref_tracker: add printing to memory
 buffer"

This reverts commit 5706be1f9c443bf64c7ac131d7a93fcc1ec2bbea.
---
 include/linux/ref_tracker.h |  8 ------
 lib/ref_tracker.c           | 56 ++++++-------------------------------
 2 files changed, 8 insertions(+), 56 deletions(-)

diff --git a/include/linux/ref_tracker.h b/include/linux/ref_tracker.h
index 2fdbfd2e14797..a2cf1f6309adb 100644
--- a/include/linux/ref_tracker.h
+++ b/include/linux/ref_tracker.h
@@ -50,8 +50,6 @@ void __ref_tracker_dir_print(struct ref_tracker_dir *dir,
 void ref_tracker_dir_print(struct ref_tracker_dir *dir,
 			   unsigned int display_limit);
 
-int ref_tracker_dir_snprint(struct ref_tracker_dir *dir, char *buf, size_t size);
-
 int ref_tracker_alloc(struct ref_tracker_dir *dir,
 		      struct ref_tracker **trackerp, gfp_t gfp);
 
@@ -80,12 +78,6 @@ static inline void ref_tracker_dir_print(struct ref_tracker_dir *dir,
 {
 }
 
-static inline int ref_tracker_dir_snprint(struct ref_tracker_dir *dir,
-					  char *buf, size_t size)
-{
-	return 0;
-}
-
 static inline int ref_tracker_alloc(struct ref_tracker_dir *dir,
 				    struct ref_tracker **trackerp,
 				    gfp_t gfp)
diff --git a/lib/ref_tracker.c b/lib/ref_tracker.c
index 2ef4596b6b36f..ab1253fde244e 100644
--- a/lib/ref_tracker.c
+++ b/lib/ref_tracker.c
@@ -62,27 +62,8 @@ ref_tracker_get_stats(struct ref_tracker_dir *dir, unsigned int limit)
 	return stats;
 }
 
-struct ostream {
-	char *buf;
-	int size, used;
-};
-
-#define pr_ostream(stream, fmt, args...) \
-({ \
-	struct ostream *_s = (stream); \
-\
-	if (!_s->buf) { \
-		pr_err(fmt, ##args); \
-	} else { \
-		int ret, len = _s->size - _s->used; \
-		ret = snprintf(_s->buf + _s->used, len, pr_fmt(fmt), ##args); \
-		_s->used += min(ret, len); \
-	} \
-})
-
-static void
-__ref_tracker_dir_pr_ostream(struct ref_tracker_dir *dir,
-			     unsigned int display_limit, struct ostream *s)
+void __ref_tracker_dir_print(struct ref_tracker_dir *dir,
+			   unsigned int display_limit)
 {
 	struct ref_tracker_dir_stats *stats;
 	unsigned int i = 0, skipped;
@@ -96,8 +77,8 @@ __ref_tracker_dir_pr_ostream(struct ref_tracker_dir *dir,
 
 	stats = ref_tracker_get_stats(dir, display_limit);
 	if (IS_ERR(stats)) {
-		pr_ostream(s, "%s@%pK: couldn't get stats, error %pe\n",
-			   dir->name, dir, stats);
+		pr_err("%s@%pK: couldn't get stats, error %pe\n",
+		       dir->name, dir, stats);
 		return;
 	}
 
@@ -107,27 +88,19 @@ __ref_tracker_dir_pr_ostream(struct ref_tracker_dir *dir,
 		stack = stats->stacks[i].stack_handle;
 		if (sbuf && !stack_depot_snprint(stack, sbuf, STACK_BUF_SIZE, 4))
 			sbuf[0] = 0;
-		pr_ostream(s, "%s@%pK has %d/%d users at\n%s\n", dir->name, dir,
-			   stats->stacks[i].count, stats->total, sbuf);
+		pr_err("%s@%pK has %d/%d users at\n%s\n", dir->name, dir,
+		       stats->stacks[i].count, stats->total, sbuf);
 		skipped -= stats->stacks[i].count;
 	}
 
 	if (skipped)
-		pr_ostream(s, "%s@%pK skipped reports about %d/%d users.\n",
-			   dir->name, dir, skipped, stats->total);
+		pr_err("%s@%pK skipped reports about %d/%d users.\n",
+		       dir->name, dir, skipped, stats->total);
 
 	kfree(sbuf);
 
 	kfree(stats);
 }
-
-void __ref_tracker_dir_print(struct ref_tracker_dir *dir,
-			   unsigned int display_limit)
-{
-	struct ostream os = {};
-
-	__ref_tracker_dir_pr_ostream(dir, display_limit, &os);
-}
 EXPORT_SYMBOL(__ref_tracker_dir_print);
 
 void ref_tracker_dir_print(struct ref_tracker_dir *dir,
@@ -141,19 +114,6 @@ void ref_tracker_dir_print(struct ref_tracker_dir *dir,
 }
 EXPORT_SYMBOL(ref_tracker_dir_print);
 
-int ref_tracker_dir_snprint(struct ref_tracker_dir *dir, char *buf, size_t size)
-{
-	struct ostream os = { .buf = buf, .size = size };
-	unsigned long flags;
-
-	spin_lock_irqsave(&dir->lock, flags);
-	__ref_tracker_dir_pr_ostream(dir, 16, &os);
-	spin_unlock_irqrestore(&dir->lock, flags);
-
-	return os.used;
-}
-EXPORT_SYMBOL(ref_tracker_dir_snprint);
-
 void ref_tracker_dir_exit(struct ref_tracker_dir *dir)
 {
 	struct ref_tracker *tracker, *n;
-- 
2.25.1

