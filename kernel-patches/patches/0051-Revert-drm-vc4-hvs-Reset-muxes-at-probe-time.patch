From abcab4de7a0fce72c67663445d29eabc201e2393 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Tue, 19 Jul 2022 14:50:02 +0800
Subject: [PATCH 51/62] Revert "drm/vc4: hvs: Reset muxes at probe time"

This reverts commit 15cec7dfd3df29f93b0f9df4510a36c2c8a7b672.
---
 drivers/gpu/drm/vc4/vc4_hvs.c | 26 +++++---------------------
 1 file changed, 5 insertions(+), 21 deletions(-)

diff --git a/drivers/gpu/drm/vc4/vc4_hvs.c b/drivers/gpu/drm/vc4/vc4_hvs.c
index 95fa6fc052a7..ad691571d759 100644
--- a/drivers/gpu/drm/vc4/vc4_hvs.c
+++ b/drivers/gpu/drm/vc4/vc4_hvs.c
@@ -564,7 +564,6 @@ static int vc4_hvs_bind(struct device *dev, struct device *master, void *data)
 	struct vc4_hvs *hvs = NULL;
 	int ret;
 	u32 dispctrl;
-	u32 reg;
 
 	hvs = devm_kzalloc(&pdev->dev, sizeof(*hvs), GFP_KERNEL);
 	if (!hvs)
@@ -636,26 +635,6 @@ static int vc4_hvs_bind(struct device *dev, struct device *master, void *data)
 
 	vc4->hvs = hvs;
 
-	reg = HVS_READ(SCALER_DISPECTRL);
-	reg &= ~SCALER_DISPECTRL_DSP2_MUX_MASK;
-	HVS_WRITE(SCALER_DISPECTRL,
-		  reg | VC4_SET_FIELD(0, SCALER_DISPECTRL_DSP2_MUX));
-
-	reg = HVS_READ(SCALER_DISPCTRL);
-	reg &= ~SCALER_DISPCTRL_DSP3_MUX_MASK;
-	HVS_WRITE(SCALER_DISPCTRL,
-		  reg | VC4_SET_FIELD(3, SCALER_DISPCTRL_DSP3_MUX));
-
-	reg = HVS_READ(SCALER_DISPEOLN);
-	reg &= ~SCALER_DISPEOLN_DSP4_MUX_MASK;
-	HVS_WRITE(SCALER_DISPEOLN,
-		  reg | VC4_SET_FIELD(3, SCALER_DISPEOLN_DSP4_MUX));
-
-	reg = HVS_READ(SCALER_DISPDITHER);
-	reg &= ~SCALER_DISPDITHER_DSP5_MUX_MASK;
-	HVS_WRITE(SCALER_DISPDITHER,
-		  reg | VC4_SET_FIELD(3, SCALER_DISPDITHER_DSP5_MUX));
-
 	dispctrl = HVS_READ(SCALER_DISPCTRL);
 
 	dispctrl |= SCALER_DISPCTRL_ENABLE;
@@ -663,6 +642,10 @@ static int vc4_hvs_bind(struct device *dev, struct device *master, void *data)
 		    SCALER_DISPCTRL_DISPEIRQ(1) |
 		    SCALER_DISPCTRL_DISPEIRQ(2);
 
+	/* Set DSP3 (PV1) to use HVS channel 2, which would otherwise
+	 * be unused.
+	 */
+	dispctrl &= ~SCALER_DISPCTRL_DSP3_MUX_MASK;
 	dispctrl &= ~(SCALER_DISPCTRL_DMAEIRQ |
 		      SCALER_DISPCTRL_SLVWREIRQ |
 		      SCALER_DISPCTRL_SLVRDEIRQ |
@@ -676,6 +659,7 @@ static int vc4_hvs_bind(struct device *dev, struct device *master, void *data)
 		      SCALER_DISPCTRL_DSPEISLUR(1) |
 		      SCALER_DISPCTRL_DSPEISLUR(2) |
 		      SCALER_DISPCTRL_SCLEIRQ);
+	dispctrl |= VC4_SET_FIELD(2, SCALER_DISPCTRL_DSP3_MUX);
 
 	HVS_WRITE(SCALER_DISPCTRL, dispctrl);
 
-- 
2.27.0

