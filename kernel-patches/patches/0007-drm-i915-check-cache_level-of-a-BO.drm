From 2ef5b676563554f6fcf68025d2e2ca920e69512b Mon Sep 17 00:00:00 2001
From: Fei Yang <fei.yang@intel.com>
Date: Mon, 10 Apr 2023 16:40:10 -0700
Subject: [PATCH 07/22] drm/i915: check cache_level of a BO

The current implementation of i915_gem_object_has_cache_level doesn't
cover all possible PAT indices. However for the objects with pat_index
set by KMD, the pat_index is converted from the old i915_cache_level,
so comparing pat_index against i915_gem_get_pat_index() is valid. For
the objects whose pat_index are set by the UMD, the caching behavior
should be managed by the UMD, and KMD shouldn't apply any additional
operation, so i915_gem_object_has_cache_level simply returns true.

Signed-off-by: Fei Yang <fei.yang@intel.com>
---
 drivers/gpu/drm/i915/gem/i915_gem_object.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/gpu/drm/i915/gem/i915_gem_object.c b/drivers/gpu/drm/i915/gem/i915_gem_object.c
index 897ab36ec39e..8becc42cc400 100644
--- a/drivers/gpu/drm/i915/gem/i915_gem_object.c
+++ b/drivers/gpu/drm/i915/gem/i915_gem_object.c
@@ -209,6 +209,12 @@ bool i915_gem_object_can_bypass_llc(struct drm_i915_gem_object *obj)
 	if (!(obj->flags & I915_BO_ALLOC_USER))
 		return false;
 
+	/*
+	 * Always flush cache for UMD objects at creation time.
+	 */
+	if (obj->cache_level == I915_CACHE_INVAL)
+		return true;
+
 	/*
 	 * EHL and JSL add the 'Bypass LLC' MOCS entry, which should make it
 	 * possible for userspace to bypass the GTT caching bits set by the
-- 
2.25.1

