From 1d875c39f2870ff486cf08005de2c71a6ffc7287 Mon Sep 17 00:00:00 2001
From: Junxiao Chang <junxiao.chang@intel.com>
Date: Mon, 28 Nov 2022 13:11:36 +0800
Subject: [PATCH 0004/2779] Revert "drm/virtio: use the fence for every plane
 update"

This reverts commit 0d112976fc629a35bf5f8644d7e518cf265f899b.
---
 drivers/gpu/drm/virtio/virtgpu_plane.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/virtio/virtgpu_plane.c b/drivers/gpu/drm/virtio/virtgpu_plane.c
index a0091529f2c1..c7f8aa5774e6 100644
--- a/drivers/gpu/drm/virtio/virtgpu_plane.c
+++ b/drivers/gpu/drm/virtio/virtgpu_plane.c
@@ -142,7 +142,12 @@ static void virtio_gpu_resource_flush(struct drm_plane *plane,
 
 	vgfb = to_virtio_gpu_framebuffer(plane->state->fb);
 	bo = gem_to_virtio_gpu_obj(vgfb->base.obj[0]);
-	fence = virtio_gpu_fence_alloc(vgdev, vgdev->fence_drv.context, 0);
+
+	if (bo && bo->dumb && (plane->state->fb != new_state->fb) &&
+	    ((plane->type == DRM_PLANE_TYPE_PRIMARY && bo->guest_blob) ||
+	    plane->type != DRM_PLANE_TYPE_PRIMARY))
+		fence = virtio_gpu_fence_alloc(vgdev, vgdev->fence_drv.context,
+					       0);
 
 	if (fence) {
 		objs = virtio_gpu_array_alloc(1);
-- 
2.25.1

