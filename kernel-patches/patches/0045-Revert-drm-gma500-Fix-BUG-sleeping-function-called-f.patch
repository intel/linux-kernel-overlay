From 02e9d05afa3fa2d1fc89862fc63da853b4b2ca2f Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Sun, 20 Nov 2022 20:21:10 +0800
Subject: [PATCH 45/56] Revert "drm/gma500: Fix BUG: sleeping function called
 from invalid context errors"

This reverts commit c5812807e416618477d1bb0049727ce8bb8292fd.
---
 drivers/gpu/drm/gma500/gma_display.c | 11 ++++-------
 1 file changed, 4 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/gma500/gma_display.c b/drivers/gpu/drm/gma500/gma_display.c
index 70148ae16f14..3df6d6e850f5 100644
--- a/drivers/gpu/drm/gma500/gma_display.c
+++ b/drivers/gpu/drm/gma500/gma_display.c
@@ -529,18 +529,15 @@ int gma_crtc_page_flip(struct drm_crtc *crtc,
 		WARN_ON(drm_crtc_vblank_get(crtc) != 0);
 
 		gma_crtc->page_flip_event = event;
-		spin_unlock_irqrestore(&dev->event_lock, flags);
 
 		/* Call this locked if we want an event at vblank interrupt. */
 		ret = crtc_funcs->mode_set_base(crtc, crtc->x, crtc->y, old_fb);
 		if (ret) {
-			spin_lock_irqsave(&dev->event_lock, flags);
-			if (gma_crtc->page_flip_event) {
-				gma_crtc->page_flip_event = NULL;
-				drm_crtc_vblank_put(crtc);
-			}
-			spin_unlock_irqrestore(&dev->event_lock, flags);
+			gma_crtc->page_flip_event = NULL;
+			drm_crtc_vblank_put(crtc);
 		}
+
+		spin_unlock_irqrestore(&dev->event_lock, flags);
 	} else {
 		ret = crtc_funcs->mode_set_base(crtc, crtc->x, crtc->y, old_fb);
 	}
-- 
2.25.1

