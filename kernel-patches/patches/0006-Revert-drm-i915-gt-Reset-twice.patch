From 31b7cd198f71a2239104fbc8b20710bdcd2eeda8 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Mon, 6 Feb 2023 10:14:17 +0800
Subject: [PATCH 06/45] Revert "drm/i915/gt: Reset twice"

This reverts commit 413638f61501c9e2a592a5846a789968cd7b39a6.
---
 drivers/gpu/drm/i915/gt/intel_reset.c | 34 +++++----------------------
 1 file changed, 6 insertions(+), 28 deletions(-)

diff --git a/drivers/gpu/drm/i915/gt/intel_reset.c b/drivers/gpu/drm/i915/gt/intel_reset.c
index 00b5912a88b82..ac36b67fb46be 100644
--- a/drivers/gpu/drm/i915/gt/intel_reset.c
+++ b/drivers/gpu/drm/i915/gt/intel_reset.c
@@ -289,7 +289,6 @@ static int ilk_do_reset(struct intel_gt *gt, intel_engine_mask_t engine_mask,
 static int gen6_hw_domain_reset(struct intel_gt *gt, u32 hw_domain_mask)
 {
 	struct intel_uncore *uncore = gt->uncore;
-	int loops = 2;
 	int err;
 
 	/*
@@ -297,39 +296,18 @@ static int gen6_hw_domain_reset(struct intel_gt *gt, u32 hw_domain_mask)
 	 * for fifo space for the write or forcewake the chip for
 	 * the read
 	 */
-	do {
-		intel_uncore_write_fw(uncore, GEN6_GDRST, hw_domain_mask);
+	intel_uncore_write_fw(uncore, GEN6_GDRST, hw_domain_mask);
 
-		/*
-		 * Wait for the device to ack the reset requests.
-		 *
-		 * On some platforms, e.g. Jasperlake, we see that the
-		 * engine register state is not cleared until shortly after
-		 * GDRST reports completion, causing a failure as we try
-		 * to immediately resume while the internal state is still
-		 * in flux. If we immediately repeat the reset, the second
-		 * reset appears to serialise with the first, and since
-		 * it is a no-op, the registers should retain their reset
-		 * value. However, there is still a concern that upon
-		 * leaving the second reset, the internal engine state
-		 * is still in flux and not ready for resuming.
-		 */
-		err = __intel_wait_for_register_fw(uncore, GEN6_GDRST,
-						   hw_domain_mask, 0,
-						   2000, 0,
-						   NULL);
-	} while (err == 0 && --loops);
+	/* Wait for the device to ack the reset requests */
+	err = __intel_wait_for_register_fw(uncore,
+					   GEN6_GDRST, hw_domain_mask, 0,
+					   500, 0,
+					   NULL);
 	if (err)
 		drm_dbg(&gt->i915->drm,
 			"Wait for 0x%08x engines reset failed\n",
 			hw_domain_mask);
 
-	/*
-	 * As we have observed that the engine state is still volatile
-	 * after GDRST is acked, impose a small delay to let everything settle.
-	 */
-	udelay(50);
-
 	return err;
 }
 
-- 
2.25.1

