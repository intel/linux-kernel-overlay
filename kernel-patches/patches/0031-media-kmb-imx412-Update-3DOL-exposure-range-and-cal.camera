From 0fe68ed4549d2a84d3e8c7686da42ce2285dd257 Mon Sep 17 00:00:00 2001
From: Vanessa Stoynova <vstoynova@mm-sol.com>
Date: Thu, 25 Feb 2021 17:10:33 +0200
Subject: [PATCH 31/42] media: kmb-imx412: Update 3DOL exposure range and
 calculations

- fix in 3DoL exp calculations
- fix exposure ranges

Signed-off-by: Vanessa Stoynova <vstoynova@mm-sol.com>
---
 drivers/media/i2c/kmb-imx412.c | 32 +++++++++++++++++---------------
 1 file changed, 17 insertions(+), 15 deletions(-)

diff --git a/drivers/media/i2c/kmb-imx412.c b/drivers/media/i2c/kmb-imx412.c
index 14213b09dd91..cb4353125080 100644
--- a/drivers/media/i2c/kmb-imx412.c
+++ b/drivers/media/i2c/kmb-imx412.c
@@ -42,23 +42,23 @@
 #define KMB_IMX412_EXPOSURE_MIN_OFFSET_TO_LPFR	22
 
 #define KMB_IMX412_REG_DOL_EXPOSURE_CIT_1ST_FRM			0x00EA
-#define KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_MIN			2
-#define KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_STEP		1
+#define KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_MIN			8
+#define KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_STEP		2
 #define KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_DEFAULT		0x0648
 #define KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_MIN_OFFSET		22
 
 #define KMB_IMX412_REG_DOL_OFFSET_2ND_FRM			0x00E6
 #define KMB_IMX412_REG_DOL_EXPOSURE_CIT_2ND_FRM			0x00EC
-#define KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_MIN			2
-#define KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_STEP		1
-#define KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_DEFAULT		0x0648
+#define KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_MIN			8
+#define KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_STEP		2
+#define KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_DEFAULT		0x00E0
 #define KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_MIN_OFFSET		22
 
 #define KMB_IMX412_REG_DOL_OFFSET_3RD_FRM			0x00E8
 #define KMB_IMX412_REG_DOL_EXPOSURE_CIT_3RD_FRM			0x00EE
-#define KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN			2
-#define KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_STEP		1
-#define KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_DEFAULT		0x0648
+#define KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN			8
+#define KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_STEP		2
+#define KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_DEFAULT		0x000E
 #define KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN_OFFSET		22
 
 /* Analog gain control */
@@ -2422,8 +2422,10 @@ static int kmb_imx412_set_ctrl(struct v4l2_ctrl *ctrl)
 		exposure[1] = ALIGN(exposure[1], 2);
 
 		if (exposure[2] > kmb_imx412->cur_mode->lpfr[2] -
+				kmb_imx412->cur_mode->lpfr[1] -
 				KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN_OFFSET)
 			exposure[2] = kmb_imx412->cur_mode->lpfr[2] -
+				kmb_imx412->cur_mode->lpfr[1] -
 				KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN_OFFSET;
 		else if (exposure[2] < KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN)
 			exposure[2] = KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN;
@@ -3110,13 +3112,13 @@ static void kmb_imx412_update_controls(struct kmb_imx412 *kmb_imx412,
 				KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_MIN,
 				mode->lpfr[0] -
 				KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_MIN_OFFSET,
-				1,
+				KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_STEP,
 				KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_DEFAULT);
 		__v4l2_ctrl_modify_range(kmb_imx412->exp_ctrl1,
 				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_MIN,
 				mode->lpfr[1] -
 				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_MIN_OFFSET,
-				1,
+				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_STEP,
 				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_DEFAULT);
 		break;
 	case KMB_IMX412_3DOL_HDR:
@@ -3137,19 +3139,19 @@ static void kmb_imx412_update_controls(struct kmb_imx412 *kmb_imx412,
 				KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_MIN,
 				mode->lpfr[0] -
 				KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_MIN_OFFSET,
-				1,
+				KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_STEP,
 				KMB_IMX412_DOL_EXPOSURE_CIT_1ST_FRM_DEFAULT);
 		__v4l2_ctrl_modify_range(kmb_imx412->exp_ctrl1,
 				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_MIN,
 				mode->lpfr[1]-
 				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_MIN_OFFSET,
-				1,
+				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_STEP,
 				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_DEFAULT);
 		__v4l2_ctrl_modify_range(kmb_imx412->exp_ctrl2,
 				KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN,
-				mode->lpfr[2] -
-				KMB_IMX412_DOL_EXPOSURE_CIT_2ND_FRM_MIN_OFFSET,
-				1,
+				mode->lpfr[2] - mode->lpfr[1] -
+				KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_MIN_OFFSET,
+				KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_STEP,
 				KMB_IMX412_DOL_EXPOSURE_CIT_3RD_FRM_DEFAULT);
 		break;
 	default:
-- 
2.17.1

