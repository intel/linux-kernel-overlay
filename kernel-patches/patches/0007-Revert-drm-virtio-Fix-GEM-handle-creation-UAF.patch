From 9f345aaeee4c0a5fcd1407c8e5e01659d06e1517 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Mon, 6 Feb 2023 10:14:18 +0800
Subject: [PATCH 07/45] Revert "drm/virtio: Fix GEM handle creation UAF"

This reverts commit 68bcd063857075d2f9edfed6024387ac377923e2.
---
 drivers/gpu/drm/virtio/virtgpu_ioctl.c | 10 +---------
 1 file changed, 1 insertion(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/virtio/virtgpu_ioctl.c b/drivers/gpu/drm/virtio/virtgpu_ioctl.c
index 36efa273155df..33b8ebab178a1 100644
--- a/drivers/gpu/drm/virtio/virtgpu_ioctl.c
+++ b/drivers/gpu/drm/virtio/virtgpu_ioctl.c
@@ -279,18 +279,10 @@ static int virtio_gpu_resource_create_ioctl(struct drm_device *dev, void *data,
 		drm_gem_object_release(obj);
 		return ret;
 	}
+	drm_gem_object_put(obj);
 
 	rc->res_handle = qobj->hw_res_handle; /* similiar to a VM address */
 	rc->bo_handle = handle;
-
-	/*
-	 * The handle owns the reference now.  But we must drop our
-	 * remaining reference *after* we no longer need to dereference
-	 * the obj.  Otherwise userspace could guess the handle and
-	 * race closing it from another thread.
-	 */
-	drm_gem_object_put(obj);
-
 	return 0;
 }
 
-- 
2.25.1

