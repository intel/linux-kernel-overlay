From a3264d72861919ae72ddb3992eb77b4bbc248940 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Wed, 18 Jan 2023 01:00:45 +0800
Subject: [PATCH 4/5] Revert "drm/shmem-helper: Remove errant put in error
 path"

This reverts commit 6a4da05acd062ae7774b6b19cef2b7d922902d36.
---
 drivers/gpu/drm/drm_gem_shmem_helper.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/drm_gem_shmem_helper.c b/drivers/gpu/drm/drm_gem_shmem_helper.c
index 8b97e25b8b0ce..cfacce0418a49 100644
--- a/drivers/gpu/drm/drm_gem_shmem_helper.c
+++ b/drivers/gpu/drm/drm_gem_shmem_helper.c
@@ -616,8 +616,10 @@ int drm_gem_shmem_mmap(struct drm_gem_object *obj, struct vm_area_struct *vma)
 	shmem = to_drm_gem_shmem_obj(obj);
 
 	ret = drm_gem_shmem_get_pages(shmem);
-	if (ret)
+	if (ret) {
+		drm_gem_vm_close(vma);
 		return ret;
+	}
 
 	vma->vm_flags |= VM_MIXEDMAP | VM_DONTEXPAND;
 	vma->vm_page_prot = vm_get_page_prot(vma->vm_flags);
-- 
2.25.1

