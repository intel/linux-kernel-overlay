From 5e7cb8b326dead031733a73014899a7252184948 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Tue, 27 Jul 2021 00:06:36 +0800
Subject: [PATCH 31/77] Revert "drm/amdkfd: fix circular locking on
 get_wave_state"

This reverts commit cd29db48bb65e53efe4b05c75e575c5f1af5ddaf.
---
 .../drm/amd/amdkfd/kfd_device_queue_manager.c | 28 ++++++++++---------
 1 file changed, 15 insertions(+), 13 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c b/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
index b971532e69eb..6ea8a4b6efde 100644
--- a/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
+++ b/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
@@ -1677,27 +1677,29 @@ static int get_wave_state(struct device_queue_manager *dqm,
 			  u32 *save_area_used_size)
 {
 	struct mqd_manager *mqd_mgr;
+	int r;
 
 	dqm_lock(dqm);
 
-	mqd_mgr = dqm->mqd_mgrs[KFD_MQD_TYPE_CP];
-
 	if (q->properties.type != KFD_QUEUE_TYPE_COMPUTE ||
-	    q->properties.is_active || !q->device->cwsr_enabled ||
-	    !mqd_mgr->get_wave_state) {
-		dqm_unlock(dqm);
-		return -EINVAL;
+	    q->properties.is_active || !q->device->cwsr_enabled) {
+		r = -EINVAL;
+		goto dqm_unlock;
 	}
 
-	dqm_unlock(dqm);
+	mqd_mgr = dqm->mqd_mgrs[KFD_MQD_TYPE_CP];
 
-	/*
-	 * get_wave_state is outside the dqm lock to prevent circular locking
-	 * and the queue should be protected against destruction by the process
-	 * lock.
-	 */
-	return mqd_mgr->get_wave_state(mqd_mgr, q->mqd, ctl_stack,
+	if (!mqd_mgr->get_wave_state) {
+		r = -EINVAL;
+		goto dqm_unlock;
+	}
+
+	r = mqd_mgr->get_wave_state(mqd_mgr, q->mqd, ctl_stack,
 			ctl_stack_used_size, save_area_used_size);
+
+dqm_unlock:
+	dqm_unlock(dqm);
+	return r;
 }
 
 static int process_termination_cpsch(struct device_queue_manager *dqm,
-- 
2.25.1

