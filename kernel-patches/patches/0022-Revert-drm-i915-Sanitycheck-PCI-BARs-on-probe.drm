From a8d2542bd3b5078a3b24b89208e29664bc2f8231 Mon Sep 17 00:00:00 2001
From: Junxiao Chang <junxiao.chang@intel.com>
Date: Mon, 28 Nov 2022 13:11:40 +0800
Subject: [PATCH 0022/2779] Revert "drm/i915: Sanitycheck PCI BARs on probe"

This reverts commit 8f33b17765e851af99be1a2b0702478aad47ae7b.
---
 drivers/gpu/drm/i915/i915_pci.c         | 32 -------------------------
 drivers/gpu/drm/i915/intel_pci_config.h |  5 ----
 2 files changed, 37 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_pci.c b/drivers/gpu/drm/i915/i915_pci.c
index e4624a87d2ae..acf688b698c3 100644
--- a/drivers/gpu/drm/i915/i915_pci.c
+++ b/drivers/gpu/drm/i915/i915_pci.c
@@ -30,7 +30,6 @@
 #include "i915_drv.h"
 #include "i915_pci.h"
 #include "i915_reg.h"
-#include "intel_pci_config.h"
 
 #define PLATFORM(x) .platform = (x)
 #define GEN(x) \
@@ -1225,34 +1224,6 @@ static bool force_probe(u16 device_id, const char *devices)
 	return ret;
 }
 
-static bool __pci_resource_valid(struct pci_dev *pdev, int bar)
-{
-	if (!pci_resource_flags(pdev, bar))
-		return false;
-
-	if (pci_resource_flags(pdev, bar) & IORESOURCE_UNSET)
-		return false;
-
-	if (!pci_resource_len(pdev, bar))
-		return false;
-
-	return true;
-}
-
-static bool intel_bars_valid(struct pci_dev *pdev, struct intel_device_info *intel_info)
-{
-	const int gttmmaddr_bar = intel_info->graphics.ver == 2 ? GEN2_GTTMMADR_BAR : GTTMMADR_BAR;
-	const int gfxmem_bar = GFXMEM_BAR;
-
-	if (!__pci_resource_valid(pdev, gttmmaddr_bar))
-		return false;
-
-	if (!__pci_resource_valid(pdev, gfxmem_bar))
-		return false;
-
-	return true;
-}
-
 static int i915_pci_probe(struct pci_dev *pdev, const struct pci_device_id *ent)
 {
 	struct intel_device_info *intel_info =
@@ -1278,9 +1249,6 @@ static int i915_pci_probe(struct pci_dev *pdev, const struct pci_device_id *ent)
 	if (PCI_FUNC(pdev->devfn))
 		return -ENODEV;
 
-	if (!intel_bars_valid(pdev, intel_info))
-		return -ENODEV;
-
 	/* Detect if we need to wait for other drivers early on */
 	if (intel_modeset_probe_defer(pdev))
 		return -EPROBE_DEFER;
diff --git a/drivers/gpu/drm/i915/intel_pci_config.h b/drivers/gpu/drm/i915/intel_pci_config.h
index c08fd5d48ada..12cd9d4f23de 100644
--- a/drivers/gpu/drm/i915/intel_pci_config.h
+++ b/drivers/gpu/drm/i915/intel_pci_config.h
@@ -6,11 +6,6 @@
 #ifndef __INTEL_PCI_CONFIG_H__
 #define __INTEL_PCI_CONFIG_H__
 
-/* PCI BARs */
-#define GTTMMADR_BAR				0
-#define GEN2_GTTMMADR_BAR			1
-#define GFXMEM_BAR				2
-
 /* BSM in include/drm/i915_drm.h */
 
 #define MCHBAR_I915				0x44
-- 
2.25.1

