From 340d93f35b33455d5e40b5d353c57deac7cc0a33 Mon Sep 17 00:00:00 2001
From: Alexander Usyskin <alexander.usyskin@intel.com>
Date: Mon, 29 May 2023 19:08:43 +0300
Subject: [PATCH 16/19] INTEL_DII: mei: add force-wake callbacks to empty
 handlers

In case of HW error the HW registers should not be touched,
so empty ops handlers struct replaces regular ops in this case.
Add dummy force-wake get and put callbacks to empty handlers struct.
This avoids the null-deref while clean-up call tries to put
the force-wake counters.

Signed-off-by: Alexander Usyskin <alexander.usyskin@intel.com>
Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
---
 drivers/misc/mei/gsc-me.c  | 27 ++++++++++++++++++++++++++-
 drivers/misc/mei/mei_dev.h |  3 +++
 2 files changed, 29 insertions(+), 1 deletion(-)

diff --git a/drivers/misc/mei/gsc-me.c b/drivers/misc/mei/gsc-me.c
index 7a8104f321d4..21a0aa449aa7 100644
--- a/drivers/misc/mei/gsc-me.c
+++ b/drivers/misc/mei/gsc-me.c
@@ -302,6 +302,28 @@ static int mei_gsc_hw_reset_null(struct mei_device *dev, bool intr_enable)
 	return 0;
 }
 
+/**
+ * mei_gsc_forcewake_get_null - get forcewake counter (empty implementation)
+ *
+ * @dev: mei device
+ * Return: always true
+ */
+static int mei_gsc_forcewake_get_null(struct mei_device *dev)
+{
+	return 0;
+}
+
+/**
+ * mei_gsc_forcewake_put_null - put forcewake counter (empty implementation)
+ *
+ * @dev: mei device
+ * Return: always true
+ */
+static int mei_gsc_forcewake_put_null(struct mei_device *dev)
+{
+	return 0;
+}
+
 static const struct mei_hw_ops mei_gsc_hw_ops_null = {
 	.trc_status = mei_gsc_trc_status_null,
 	.fw_status = mei_gsc_fw_status_null,
@@ -330,7 +352,10 @@ static const struct mei_hw_ops mei_gsc_hw_ops_null = {
 
 	.rdbuf_full_slots = mei_gsc_count_full_read_slots_null,
 	.read_hdr = mei_gsc_mecbrw_read_null,
-	.read = mei_gsc_read_slots_null
+	.read = mei_gsc_read_slots_null,
+
+	.forcewake_get = mei_gsc_forcewake_get_null,
+	.forcewake_put = mei_gsc_forcewake_put_null,
 };
 
 #define MEI_GSC_RESET_BEGIN_TIMEOUT 300
diff --git a/drivers/misc/mei/mei_dev.h b/drivers/misc/mei/mei_dev.h
index 842f80e8a422..4114db6f6405 100644
--- a/drivers/misc/mei/mei_dev.h
+++ b/drivers/misc/mei/mei_dev.h
@@ -357,6 +357,9 @@ struct mei_cl {
  *
  * @read_hdr         : get first 4 bytes (header)
  * @read             : read a buffer from the FW
+ *
+ * @forcewake_get    : get forcewake counter
+ * @forcewake_put    : put forcewake counter
  */
 struct mei_hw_ops {
 
-- 
2.25.1

