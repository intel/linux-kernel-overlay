From 5bf6011f28d0e567e1eb1b58447eede2a2bdf63d Mon Sep 17 00:00:00 2001
From: Junxiao Chang <junxiao.chang@intel.com>
Date: Wed, 24 Nov 2021 13:16:43 +0800
Subject: [PATCH 066/888] Revert "drm/i915/selftests: Add a cancel request
 selftest that triggers a reset"

This reverts commit 39e2cb7fa4ff45c2bb697f29a5cc095cfb47e19e.
---
 drivers/gpu/drm/i915/selftests/i915_request.c | 100 ------------------
 1 file changed, 100 deletions(-)

diff --git a/drivers/gpu/drm/i915/selftests/i915_request.c b/drivers/gpu/drm/i915/selftests/i915_request.c
index e2c5db77f087..d67710d10615 100644
--- a/drivers/gpu/drm/i915/selftests/i915_request.c
+++ b/drivers/gpu/drm/i915/selftests/i915_request.c
@@ -772,98 +772,6 @@ static int __cancel_completed(struct intel_engine_cs *engine)
 	return err;
 }
 
-static int __cancel_reset(struct intel_engine_cs *engine)
-{
-	struct intel_context *ce;
-	struct igt_spinner spin;
-	struct i915_request *rq, *nop;
-	unsigned long preempt_timeout_ms;
-	int err = 0;
-
-	preempt_timeout_ms = engine->props.preempt_timeout_ms;
-	engine->props.preempt_timeout_ms = 100;
-
-	if (igt_spinner_init(&spin, engine->gt))
-		goto out_restore;
-
-	ce = intel_context_create(engine);
-	if (IS_ERR(ce)) {
-		err = PTR_ERR(ce);
-		goto out_spin;
-	}
-
-	rq = igt_spinner_create_request(&spin, ce, MI_NOOP);
-	if (IS_ERR(rq)) {
-		err = PTR_ERR(rq);
-		goto out_ce;
-	}
-
-	pr_debug("%s: Cancelling active request\n", engine->name);
-	i915_request_get(rq);
-	i915_request_add(rq);
-	if (!igt_wait_for_spinner(&spin, rq)) {
-		struct drm_printer p = drm_info_printer(engine->i915->drm.dev);
-
-		pr_err("Failed to start spinner on %s\n", engine->name);
-		intel_engine_dump(engine, &p, "%s\n", engine->name);
-		err = -ETIME;
-		goto out_rq;
-	}
-
-	nop = intel_context_create_request(ce);
-	if (IS_ERR(nop))
-		goto out_nop;
-	i915_request_get(nop);
-	i915_request_add(nop);
-
-	i915_request_cancel(rq, -EINTR);
-
-	if (i915_request_wait(rq, 0, HZ) < 0) {
-		struct drm_printer p = drm_info_printer(engine->i915->drm.dev);
-
-		pr_err("%s: Failed to cancel hung request\n", engine->name);
-		intel_engine_dump(engine, &p, "%s\n", engine->name);
-		err = -ETIME;
-		goto out_nop;
-	}
-
-	if (rq->fence.error != -EINTR) {
-		pr_err("%s: fence not cancelled (%u)\n",
-		       engine->name, rq->fence.error);
-		err = -EINVAL;
-		goto out_nop;
-	}
-
-	if (i915_request_wait(nop, 0, HZ) < 0) {
-		struct drm_printer p = drm_info_printer(engine->i915->drm.dev);
-
-		pr_err("%s: Failed to complete nop request\n", engine->name);
-		intel_engine_dump(engine, &p, "%s\n", engine->name);
-		err = -ETIME;
-		goto out_nop;
-	}
-
-	if (nop->fence.error != 0) {
-		pr_err("%s: Nop request errored (%u)\n",
-		       engine->name, nop->fence.error);
-		err = -EINVAL;
-	}
-
-out_nop:
-	i915_request_put(nop);
-out_rq:
-	i915_request_put(rq);
-out_ce:
-	intel_context_put(ce);
-out_spin:
-	igt_spinner_fini(&spin);
-out_restore:
-	engine->props.preempt_timeout_ms = preempt_timeout_ms;
-	if (err)
-		pr_err("%s: %s error %d\n", __func__, engine->name, err);
-	return err;
-}
-
 static int live_cancel_request(void *arg)
 {
 	struct drm_i915_private *i915 = arg;
@@ -896,14 +804,6 @@ static int live_cancel_request(void *arg)
 			return err;
 		if (err2)
 			return err2;
-
-		/* Expects reset so call outside of igt_live_test_* */
-		err = __cancel_reset(engine);
-		if (err)
-			return err;
-
-		if (igt_flush_test(i915))
-			return -EIO;
 	}
 
 	return 0;
-- 
2.25.1

