From 212dd786ac3d81d4d24d3f98cbad2b06f54f9921 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Tue, 27 Jul 2021 00:06:48 +0800
Subject: [PATCH 71/77] Revert "drm/vmwgfx: Fix cpu updates of coherent
 multisample surfaces"

This reverts commit 40b701707ebfc7f362fdbf3fdf7c2803e86fa552.
---
 .../drm/vmwgfx/device_include/svga3d_surfacedefs.h  |  8 ++------
 drivers/gpu/drm/vmwgfx/vmwgfx_surface.c             | 13 -------------
 2 files changed, 2 insertions(+), 19 deletions(-)

diff --git a/drivers/gpu/drm/vmwgfx/device_include/svga3d_surfacedefs.h b/drivers/gpu/drm/vmwgfx/device_include/svga3d_surfacedefs.h
index 127eaf0a0a58..4db25bd9fa22 100644
--- a/drivers/gpu/drm/vmwgfx/device_include/svga3d_surfacedefs.h
+++ b/drivers/gpu/drm/vmwgfx/device_include/svga3d_surfacedefs.h
@@ -1467,7 +1467,6 @@ struct svga3dsurface_cache {
 
 /**
  * struct svga3dsurface_loc - Surface location
- * @sheet: The multisample sheet.
  * @sub_resource: Surface subresource. Defined as layer * num_mip_levels +
  * mip_level.
  * @x: X coordinate.
@@ -1475,7 +1474,6 @@ struct svga3dsurface_cache {
  * @z: Z coordinate.
  */
 struct svga3dsurface_loc {
-	u32 sheet;
 	u32 sub_resource;
 	u32 x, y, z;
 };
@@ -1568,8 +1566,8 @@ svga3dsurface_get_loc(const struct svga3dsurface_cache *cache,
 	u32 layer;
 	int i;
 
-	loc->sheet = offset / cache->sheet_bytes;
-	offset -= loc->sheet * cache->sheet_bytes;
+	if (offset >= cache->sheet_bytes)
+		offset %= cache->sheet_bytes;
 
 	layer = offset / cache->mip_chain_bytes;
 	offset -= layer * cache->mip_chain_bytes;
@@ -1633,7 +1631,6 @@ svga3dsurface_min_loc(const struct svga3dsurface_cache *cache,
 		      u32 sub_resource,
 		      struct svga3dsurface_loc *loc)
 {
-	loc->sheet = 0;
 	loc->sub_resource = sub_resource;
 	loc->x = loc->y = loc->z = 0;
 }
@@ -1655,7 +1652,6 @@ svga3dsurface_max_loc(const struct svga3dsurface_cache *cache,
 	const struct drm_vmw_size *size;
 	u32 mip;
 
-	loc->sheet = 0;
 	loc->sub_resource = sub_resource + 1;
 	mip = sub_resource % cache->num_mip_levels;
 	size = &cache->mip[mip].size;
diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx_surface.c b/drivers/gpu/drm/vmwgfx/vmwgfx_surface.c
index f493b20c7a38..3914bfee0533 100644
--- a/drivers/gpu/drm/vmwgfx/vmwgfx_surface.c
+++ b/drivers/gpu/drm/vmwgfx/vmwgfx_surface.c
@@ -1802,19 +1802,6 @@ static void vmw_surface_tex_dirty_range_add(struct vmw_resource *res,
 	svga3dsurface_get_loc(cache, &loc2, end - 1);
 	svga3dsurface_inc_loc(cache, &loc2);
 
-	if (loc1.sheet != loc2.sheet) {
-		u32 sub_res;
-
-		/*
-		 * Multiple multisample sheets. To do this in an optimized
-		 * fashion, compute the dirty region for each sheet and the
-		 * resulting union. Since this is not a common case, just dirty
-		 * the whole surface.
-		 */
-		for (sub_res = 0; sub_res < dirty->num_subres; ++sub_res)
-			vmw_subres_dirty_full(dirty, sub_res);
-		return;
-	}
 	if (loc1.sub_resource + 1 == loc2.sub_resource) {
 		/* Dirty range covers a single sub-resource */
 		vmw_subres_dirty_add(dirty, &loc1, &loc2);
-- 
2.25.1

