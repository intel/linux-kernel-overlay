From 55d4e362847e8aa24b3fca2771485ee29024b56a Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Wed, 18 Jan 2023 01:00:45 +0800
Subject: [PATCH 3/5] Revert "drm/shmem-helper: Avoid vm_open error paths"

This reverts commit 11e95d85c3c99a226cc7003c787e31a02ee5b2ba.
---
 drivers/gpu/drm/drm_gem_shmem_helper.c | 14 +++-----------
 1 file changed, 3 insertions(+), 11 deletions(-)

diff --git a/drivers/gpu/drm/drm_gem_shmem_helper.c b/drivers/gpu/drm/drm_gem_shmem_helper.c
index c56656a95cf99..8b97e25b8b0ce 100644
--- a/drivers/gpu/drm/drm_gem_shmem_helper.c
+++ b/drivers/gpu/drm/drm_gem_shmem_helper.c
@@ -563,20 +563,12 @@ static void drm_gem_shmem_vm_open(struct vm_area_struct *vma)
 {
 	struct drm_gem_object *obj = vma->vm_private_data;
 	struct drm_gem_shmem_object *shmem = to_drm_gem_shmem_obj(obj);
+	int ret;
 
 	WARN_ON(shmem->base.import_attach);
 
-	mutex_lock(&shmem->pages_lock);
-
-	/*
-	 * We should have already pinned the pages when the buffer was first
-	 * mmap'd, vm_open() just grabs an additional reference for the new
-	 * mm the vma is getting copied into (ie. on fork()).
-	 */
-	if (!WARN_ON_ONCE(!shmem->pages_use_count))
-		shmem->pages_use_count++;
-
-	mutex_unlock(&shmem->pages_lock);
+	ret = drm_gem_shmem_get_pages(shmem);
+	WARN_ON_ONCE(ret != 0);
 
 	drm_gem_vm_open(vma);
 }
-- 
2.25.1

