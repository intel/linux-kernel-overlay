From d5ddce97fbbe6b1b2b6ad05773480315d18fe446 Mon Sep 17 00:00:00 2001
From: Junxiao Chang <junxiao.chang@intel.com>
Date: Thu, 6 Jul 2023 15:04:18 +0800
Subject: [PATCH 0084/2351] Revert "drm/i915/mtl: Add handling for MTL ccs
 modifiers"

This reverts commit 28fc5f0c902996ea8a7b332f52c7ddb6cef468f2.
---
 drivers/gpu/drm/i915/display/intel_fb.c       | 42 +------------------
 .../drm/i915/display/skl_universal_plane.c    | 17 +-------
 2 files changed, 3 insertions(+), 56 deletions(-)

diff --git a/drivers/gpu/drm/i915/display/intel_fb.c b/drivers/gpu/drm/i915/display/intel_fb.c
index e7068fc000413..db42717d93355 100644
--- a/drivers/gpu/drm/i915/display/intel_fb.c
+++ b/drivers/gpu/drm/i915/display/intel_fb.c
@@ -157,32 +157,6 @@ struct intel_modifier_desc {
 
 static const struct intel_modifier_desc intel_modifiers[] = {
 	{
-		.modifier = I915_FORMAT_MOD_4_TILED_MTL_MC_CCS,
-		.display_ver = { 14, 14 },
-		.plane_caps = INTEL_PLANE_CAP_TILING_4 | INTEL_PLANE_CAP_CCS_MC,
-
-		.ccs.packed_aux_planes = BIT(1),
-		.ccs.planar_aux_planes = BIT(2) | BIT(3),
-
-		FORMAT_OVERRIDE(gen12_ccs_formats),
-	}, {
-		.modifier = I915_FORMAT_MOD_4_TILED_MTL_RC_CCS,
-		.display_ver = { 14, 14 },
-		.plane_caps = INTEL_PLANE_CAP_TILING_4 | INTEL_PLANE_CAP_CCS_RC,
-
-		.ccs.packed_aux_planes = BIT(1),
-
-		FORMAT_OVERRIDE(gen12_ccs_formats),
-	}, {
-		.modifier = I915_FORMAT_MOD_4_TILED_MTL_RC_CCS_CC,
-		.display_ver = { 14, 14 },
-		.plane_caps = INTEL_PLANE_CAP_TILING_4 | INTEL_PLANE_CAP_CCS_RC_CC,
-
-		.ccs.cc_planes = BIT(2),
-		.ccs.packed_aux_planes = BIT(1),
-
-		FORMAT_OVERRIDE(gen12_ccs_cc_formats),
-	}, {
 		.modifier = I915_FORMAT_MOD_4_TILED_DG2_MC_CCS,
 		.display_ver = { 13, 13 },
 		.plane_caps = INTEL_PLANE_CAP_TILING_4 | INTEL_PLANE_CAP_CCS_MC,
@@ -396,14 +370,6 @@ static bool plane_has_modifier(struct drm_i915_private *i915,
 	if (!plane_caps_contain_all(plane_caps, md->plane_caps))
 		return false;
 
-	/*
-	 * Separate AuxCCS and Flat CCS modifiers to be run only on platforms
-	 * where supported.
-	 */
-	if (intel_fb_is_ccs_modifier(md->modifier) &&
-	   HAS_FLAT_CCS(i915) != !md->ccs.packed_aux_planes)
-		return false;
-
 	return true;
 }
 
@@ -523,7 +489,7 @@ static bool intel_fb_is_gen12_ccs_aux_plane(const struct drm_framebuffer *fb, in
 {
 	const struct intel_modifier_desc *md = lookup_modifier(fb->modifier);
 
-	return check_modifier_display_ver_range(md, 12, 14) &&
+	return check_modifier_display_ver_range(md, 12, 13) &&
 	       ccs_aux_plane_mask(md, fb->format) & BIT(color_plane);
 }
 
@@ -639,9 +605,6 @@ intel_tile_width_bytes(const struct drm_framebuffer *fb, int color_plane)
 		if (intel_fb_is_ccs_aux_plane(fb, color_plane))
 			return 128;
 		fallthrough;
-	case I915_FORMAT_MOD_4_TILED_MTL_RC_CCS:
-	case I915_FORMAT_MOD_4_TILED_MTL_RC_CCS_CC:
-	case I915_FORMAT_MOD_4_TILED_MTL_MC_CCS:
 	case I915_FORMAT_MOD_Y_TILED_GEN12_RC_CCS:
 	case I915_FORMAT_MOD_Y_TILED_GEN12_RC_CCS_CC:
 	case I915_FORMAT_MOD_Y_TILED_GEN12_MC_CCS:
@@ -827,9 +790,6 @@ unsigned int intel_surf_alignment(const struct drm_framebuffer *fb,
 	case I915_FORMAT_MOD_Y_TILED_GEN12_MC_CCS:
 	case I915_FORMAT_MOD_Y_TILED_GEN12_RC_CCS:
 	case I915_FORMAT_MOD_Y_TILED_GEN12_RC_CCS_CC:
-	case I915_FORMAT_MOD_4_TILED_MTL_MC_CCS:
-	case I915_FORMAT_MOD_4_TILED_MTL_RC_CCS:
-	case I915_FORMAT_MOD_4_TILED_MTL_RC_CCS_CC:
 		return 16 * 1024;
 	case I915_FORMAT_MOD_Y_TILED_CCS:
 	case I915_FORMAT_MOD_Yf_TILED_CCS:
diff --git a/drivers/gpu/drm/i915/display/skl_universal_plane.c b/drivers/gpu/drm/i915/display/skl_universal_plane.c
index 4642108fd8d9b..ce55b8f09301b 100644
--- a/drivers/gpu/drm/i915/display/skl_universal_plane.c
+++ b/drivers/gpu/drm/i915/display/skl_universal_plane.c
@@ -790,14 +790,6 @@ static u32 skl_plane_ctl_tiling(u64 fb_modifier)
 			PLANE_CTL_CLEAR_COLOR_DISABLE;
 	case I915_FORMAT_MOD_4_TILED_DG2_RC_CCS_CC:
 		return PLANE_CTL_TILED_4 | PLANE_CTL_RENDER_DECOMPRESSION_ENABLE;
-	case I915_FORMAT_MOD_4_TILED_MTL_RC_CCS:
-		return PLANE_CTL_TILED_4 |
-			PLANE_CTL_RENDER_DECOMPRESSION_ENABLE |
-			PLANE_CTL_CLEAR_COLOR_DISABLE;
-	case I915_FORMAT_MOD_4_TILED_MTL_RC_CCS_CC:
-		return PLANE_CTL_TILED_4 | PLANE_CTL_RENDER_DECOMPRESSION_ENABLE;
-	case I915_FORMAT_MOD_4_TILED_MTL_MC_CCS:
-		return PLANE_CTL_TILED_4 | PLANE_CTL_MEDIA_DECOMPRESSION_ENABLE;
 	case I915_FORMAT_MOD_Y_TILED_CCS:
 	case I915_FORMAT_MOD_Y_TILED_GEN12_RC_CCS_CC:
 		return PLANE_CTL_TILED_Y | PLANE_CTL_RENDER_DECOMPRESSION_ENABLE;
@@ -2450,17 +2442,12 @@ skl_get_initial_plane_config(struct intel_crtc *crtc,
 	case PLANE_CTL_TILED_Y:
 		plane_config->tiling = I915_TILING_Y;
 		if (val & PLANE_CTL_RENDER_DECOMPRESSION_ENABLE)
-			if (DISPLAY_VER(dev_priv) >= 14)
-				fb->modifier = I915_FORMAT_MOD_4_TILED_MTL_RC_CCS;
-			else if (DISPLAY_VER(dev_priv) >= 12)
+			if (DISPLAY_VER(dev_priv) >= 12)
 				fb->modifier = I915_FORMAT_MOD_Y_TILED_GEN12_RC_CCS;
 			else
 				fb->modifier = I915_FORMAT_MOD_Y_TILED_CCS;
 		else if (val & PLANE_CTL_MEDIA_DECOMPRESSION_ENABLE)
-			if (DISPLAY_VER(dev_priv) >= 14)
-				fb->modifier = I915_FORMAT_MOD_4_TILED_MTL_MC_CCS;
-			else
-				fb->modifier = I915_FORMAT_MOD_Y_TILED_GEN12_MC_CCS;
+			fb->modifier = I915_FORMAT_MOD_Y_TILED_GEN12_MC_CCS;
 		else
 			fb->modifier = I915_FORMAT_MOD_Y_TILED;
 		break;
-- 
2.25.1

