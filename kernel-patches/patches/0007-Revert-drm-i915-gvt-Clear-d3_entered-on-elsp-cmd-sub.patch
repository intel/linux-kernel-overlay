From 7db118dddece7a784ac7601de102c90167725944 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Tue, 10 Aug 2021 09:42:28 +0800
Subject: [PATCH 07/11] Revert "drm/i915/gvt: Clear d3_entered on elsp cmd
 submission."

This reverts commit 1df4fe5a8871f49d34d681ff5b7f93a84d50af4b.
---
 drivers/gpu/drm/i915/gvt/handlers.c | 15 ---------------
 1 file changed, 15 deletions(-)

diff --git a/drivers/gpu/drm/i915/gvt/handlers.c b/drivers/gpu/drm/i915/gvt/handlers.c
index 0b1ea29dcffa..eb342a759943 100644
--- a/drivers/gpu/drm/i915/gvt/handlers.c
+++ b/drivers/gpu/drm/i915/gvt/handlers.c
@@ -1728,21 +1728,6 @@ static int elsp_mmio_write(struct intel_vgpu *vgpu, unsigned int offset,
 	if (drm_WARN_ON(&i915->drm, !engine))
 		return -EINVAL;
 
-	/*
-	 * Due to d3_entered is used to indicate skipping PPGTT invalidation on
-	 * vGPU reset, it's set on D0->D3 on PCI config write, and cleared after
-	 * vGPU reset if in resuming.
-	 * In S0ix exit, the device power state also transite from D3 to D0 as
-	 * S3 resume, but no vGPU reset (triggered by QEMU devic model). After
-	 * S0ix exit, all engines continue to work. However the d3_entered
-	 * remains set which will break next vGPU reset logic (miss the expected
-	 * PPGTT invalidation).
-	 * Engines can only work in D0. Thus the 1st elsp write gives GVT a
-	 * chance to clear d3_entered.
-	 */
-	if (vgpu->d3_entered)
-		vgpu->d3_entered = false;
-
 	execlist = &vgpu->submission.execlist[engine->id];
 
 	execlist->elsp_dwords.data[3 - execlist->elsp_dwords.index] = data;
-- 
2.27.0

