From f6737a2b39eb445c8cf784d2e517b5676fd19c72 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Mon, 7 Jun 2021 19:08:25 +0800
Subject: [PATCH 17/78] Revert "drm/radeon: Avoid power table parsing memory
 leaks"

This reverts commit 93dcaa8cba6561f796bcc1d53e57b1e4c9ab33cc.
---
 drivers/gpu/drm/radeon/radeon_atombios.c | 20 +++++---------------
 1 file changed, 5 insertions(+), 15 deletions(-)

diff --git a/drivers/gpu/drm/radeon/radeon_atombios.c b/drivers/gpu/drm/radeon/radeon_atombios.c
index aca6e5cfae53..96e80b0eca04 100644
--- a/drivers/gpu/drm/radeon/radeon_atombios.c
+++ b/drivers/gpu/drm/radeon/radeon_atombios.c
@@ -2126,14 +2126,11 @@ static int radeon_atombios_parse_power_table_1_3(struct radeon_device *rdev)
 		return state_index;
 	/* last mode is usually default, array is low to high */
 	for (i = 0; i < num_modes; i++) {
-		/* avoid memory leaks from invalid modes or unknown frev. */
-		if (!rdev->pm.power_state[state_index].clock_info) {
-			rdev->pm.power_state[state_index].clock_info =
-				kzalloc(sizeof(struct radeon_pm_clock_info),
-					GFP_KERNEL);
-		}
+		rdev->pm.power_state[state_index].clock_info =
+			kcalloc(1, sizeof(struct radeon_pm_clock_info),
+				GFP_KERNEL);
 		if (!rdev->pm.power_state[state_index].clock_info)
-			goto out;
+			return state_index;
 		rdev->pm.power_state[state_index].num_clock_modes = 1;
 		rdev->pm.power_state[state_index].clock_info[0].voltage.type = VOLTAGE_NONE;
 		switch (frev) {
@@ -2252,15 +2249,8 @@ static int radeon_atombios_parse_power_table_1_3(struct radeon_device *rdev)
 			break;
 		}
 	}
-out:
-	/* free any unused clock_info allocation. */
-	if (state_index && state_index < num_modes) {
-		kfree(rdev->pm.power_state[state_index].clock_info);
-		rdev->pm.power_state[state_index].clock_info = NULL;
-	}
-
 	/* last mode is usually default */
-	if (state_index && rdev->pm.default_power_state_index == -1) {
+	if (rdev->pm.default_power_state_index == -1) {
 		rdev->pm.power_state[state_index - 1].type =
 			POWER_STATE_TYPE_DEFAULT;
 		rdev->pm.default_power_state_index = state_index - 1;
-- 
2.25.1

