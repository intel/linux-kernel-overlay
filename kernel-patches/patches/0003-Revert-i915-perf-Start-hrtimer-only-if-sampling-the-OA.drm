From 4795ef5fbb3964fb551a0ec12f19a37456ed7555 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Mon, 29 Mar 2021 13:29:32 +0800
Subject: [PATCH 3/4] Revert "i915/perf: Start hrtimer only if sampling the OA
 buffer"

This reverts commit 5f7d470696add2a0eb0d9f34e32b0ced2dddb9ad.
---
 drivers/gpu/drm/i915/i915_perf.c | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_perf.c b/drivers/gpu/drm/i915/i915_perf.c
index 74e66dea5708..3640d0e229d2 100644
--- a/drivers/gpu/drm/i915/i915_perf.c
+++ b/drivers/gpu/drm/i915/i915_perf.c
@@ -600,6 +600,7 @@ static int append_oa_sample(struct i915_perf_stream *stream,
 {
 	int report_size = stream->oa_buffer.format_size;
 	struct drm_i915_perf_record_header header;
+	u32 sample_flags = stream->sample_flags;
 
 	header.type = DRM_I915_PERF_RECORD_SAMPLE;
 	header.pad = 0;
@@ -613,8 +614,10 @@ static int append_oa_sample(struct i915_perf_stream *stream,
 		return -EFAULT;
 	buf += sizeof(header);
 
-	if (copy_to_user(buf, report, report_size))
-		return -EFAULT;
+	if (sample_flags & SAMPLE_OA_REPORT) {
+		if (copy_to_user(buf, report, report_size))
+			return -EFAULT;
+	}
 
 	(*offset) += header.size;
 
@@ -2673,7 +2676,7 @@ static void i915_oa_stream_enable(struct i915_perf_stream *stream)
 
 	stream->perf->ops.oa_enable(stream);
 
-	if (stream->sample_flags & SAMPLE_OA_REPORT)
+	if (stream->periodic)
 		hrtimer_start(&stream->poll_check_timer,
 			      ns_to_ktime(stream->poll_oa_period),
 			      HRTIMER_MODE_REL_PINNED);
@@ -2736,7 +2739,7 @@ static void i915_oa_stream_disable(struct i915_perf_stream *stream)
 {
 	stream->perf->ops.oa_disable(stream);
 
-	if (stream->sample_flags & SAMPLE_OA_REPORT)
+	if (stream->periodic)
 		hrtimer_cancel(&stream->poll_check_timer);
 }
 
@@ -3019,7 +3022,7 @@ static ssize_t i915_perf_read(struct file *file,
 	 * disabled stream as an error. In particular it might otherwise lead
 	 * to a deadlock for blocking file descriptors...
 	 */
-	if (!stream->enabled || !(stream->sample_flags & SAMPLE_OA_REPORT))
+	if (!stream->enabled)
 		return -EIO;
 
 	if (!(file->f_flags & O_NONBLOCK)) {
-- 
2.25.1

