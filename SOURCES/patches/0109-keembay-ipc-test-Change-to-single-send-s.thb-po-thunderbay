From 34ffa050f960316bb535cf4175a97181b725b2c0 Mon Sep 17 00:00:00 2001
From: Daniele Alessandrelli <daniele.alessandrelli@intel.com>
Date: Tue, 12 May 2020 12:34:16 +0100
Subject: [PATCH 109/223] keembay-ipc-test: Change to single send / single
 receive

Also add retry counter for failed send due to full FIFO.

Signed-off-by: Daniele Alessandrelli <daniele.alessandrelli@intel.com>
---
 drivers/misc/keembay-ipc/keembay-ipc-test.c | 26 +++++++--------------
 1 file changed, 9 insertions(+), 17 deletions(-)

diff --git a/drivers/misc/keembay-ipc/keembay-ipc-test.c b/drivers/misc/keembay-ipc/keembay-ipc-test.c
index 514af841a72d..3db1c25a631b 100644
--- a/drivers/misc/keembay-ipc/keembay-ipc-test.c
+++ b/drivers/misc/keembay-ipc/keembay-ipc-test.c
@@ -174,7 +174,7 @@ static int test_loop_thread_fn(void *data)
 	struct test_params *params = data;
 	u16 chan_id = params->chan_id;
 	struct device *ipc_dev = params->ipc_dev;
-	int rc;
+	int rc, retry;
 	u32 paddr1, paddr2;
 	size_t size1, size2;
 	char name[TASK_COMM_LEN];
@@ -193,25 +193,17 @@ static int test_loop_thread_fn(void *data)
 		rc = intel_keembay_ipc_recv(ipc_dev, KMB_IPC_NODE_LEON_MSS,
 					    chan_id, &paddr1, &size1, U32_MAX);
 		if (rc) {
-			pr_info("Failed 1st recv(): %d\n", rc);
-			goto err;
-		}
-		rc = intel_keembay_ipc_recv(ipc_dev, KMB_IPC_NODE_LEON_MSS,
-					    chan_id, &paddr2, &size2, U32_MAX);
-		if (rc) {
-			pr_info("Failed 2nd recv(): %d\n", rc);
-			goto err;
-		}
-		rc = intel_keembay_ipc_send(ipc_dev, KMB_IPC_NODE_LEON_MSS,
-					    chan_id, paddr1, size1);
-		if (rc) {
-			pr_info("Failed 1st send(): %d\n", rc);
+			pr_info("Failed recv(): %d\n", rc);
 			goto err;
 		}
-		rc = intel_keembay_ipc_send(ipc_dev, KMB_IPC_NODE_LEON_MSS,
-					    chan_id, paddr2, size2);
+		retry = 10;
+		do {
+			rc = intel_keembay_ipc_send(ipc_dev,
+						    KMB_IPC_NODE_LEON_MSS,
+						    chan_id, paddr1, size1);
+		} while (rc == -EBUSY && retry-- > 0);
 		if (rc) {
-			pr_info("Failed 2nd send(): %d\n", rc);
+			pr_info("Failed send(): %d\n", rc);
 			goto err;
 		}
 	}
-- 
2.27.0

