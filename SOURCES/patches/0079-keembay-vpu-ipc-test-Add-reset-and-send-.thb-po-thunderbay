From 2ac04c713ad3fcee164695424bea463794b8c395 Mon Sep 17 00:00:00 2001
From: Paul Murphy <paul.j.murphy@intel.com>
Date: Mon, 11 Nov 2019 17:06:42 +0000
Subject: [PATCH 079/223] keembay-vpu-ipc-test: Add 'reset' and 'send' tests

Add 'reset' and 'send' tests

Signed-off-by: Paul Murphy <paul.j.murphy@intel.com>
---
 drivers/firmware/keembay-vpu-ipc-test.c | 64 ++++++++++++++++++++++++-
 1 file changed, 63 insertions(+), 1 deletion(-)

diff --git a/drivers/firmware/keembay-vpu-ipc-test.c b/drivers/firmware/keembay-vpu-ipc-test.c
index db44be98fda1..16700235696f 100644
--- a/drivers/firmware/keembay-vpu-ipc-test.c
+++ b/drivers/firmware/keembay-vpu-ipc-test.c
@@ -12,6 +12,43 @@
 
 #define KEEMBAY_VPU_IPC_TEST_READY_WAIT_TIME_MS (31000)
 
+#define TEST_NODE (KMB_VPU_IPC_NODE_LEON_MSS)
+#define TEST_CHANNEL (10)
+#define TEST_DATA (0x53544f50)
+#define TEST_SIZE (0)
+
+static int __init intel_keembay_vpu_ipc_test_send_data(void)
+{
+	int ret;
+	int close_ret;
+
+	ret = intel_keembay_vpu_ipc_open_channel(TEST_NODE, TEST_CHANNEL);
+	if (ret) {
+		pr_info("Failed to open channel %d:%d\n", TEST_NODE,
+			TEST_CHANNEL);
+		return ret;
+	}
+
+	ret = intel_keembay_vpu_ipc_send(TEST_NODE, TEST_CHANNEL, TEST_DATA,
+					 TEST_SIZE);
+	if (ret) {
+		pr_info("Failed to send test data 0x%x size 0x%x\n", TEST_DATA,
+			TEST_SIZE);
+	}
+
+	close_ret =
+		intel_keembay_vpu_ipc_close_channel(TEST_NODE, TEST_CHANNEL);
+	if (close_ret) {
+		pr_info("Failed to close channel %d:%d\n", TEST_NODE,
+			TEST_CHANNEL);
+	}
+
+	if (close_ret)
+		return close_ret;
+
+	return ret;
+}
+
 static int __init keem_bay_vpu_ipc_test_init(void)
 {
 	int ret;
@@ -47,7 +84,7 @@ static int __init keem_bay_vpu_ipc_test_init(void)
 		pr_err("Tried to start VPU but never got READY.\n");
 		return ret;
 	}
-	pr_info("Successfully synchronised state with VPU!\n");
+	pr_info("Successfully synchronised state with VPU - after start!\n");
 
 	/* Check state */
 	state = intel_keembay_vpu_status();
@@ -72,6 +109,31 @@ static int __init keem_bay_vpu_ipc_test_init(void)
 	}
 	pr_info("MSS WDT count = %d\n", ret);
 
+	/* Reset the VPU */
+	ret = intel_keembay_vpu_reset();
+	if (ret) {
+		pr_err("Failed to reset VPU: %d\n", ret);
+		return ret;
+	}
+	pr_info("Successfully reset VPU!\n");
+
+	/* Wait for VPU to be READY */
+	ret = intel_keembay_vpu_wait_for_ready(
+		KEEMBAY_VPU_IPC_TEST_READY_WAIT_TIME_MS);
+	if (ret) {
+		pr_err("Tried to reset VPU but never got READY.\n");
+		return ret;
+	}
+	pr_info("Successfully synchronised state with VPU - after reset!\n");
+
+	/* Send test data on test channel */
+	ret = intel_keembay_vpu_ipc_test_send_data();
+	if (ret) {
+		pr_err("Tried to send data but failed.\n");
+		return ret;
+	}
+	pr_info("Successfully sent test data!\n");
+
 	/* Stop the VPU */
 	ret = intel_keembay_vpu_stop();
 	if (ret) {
-- 
2.27.0

