From 7af06b1923910e37c6d0b6a58034a079356dd608 Mon Sep 17 00:00:00 2001
From: Simon Ser <contact@emersion.fr>
Date: Fri, 20 Nov 2020 20:18:57 +0000
Subject: [PATCH 1421/1714] drm/amd/display: disallow cropping for cursor plane

Looking at handle_cursor_update, it doesn't seem like src_{x,y,w,h}
are picked up by DC. I also tried to change these parameters via a
test KMS client, and amdgpu ignored them. Instead of displaying the
wrong result, reject the atomic commit.

Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Simon Ser <contact@emersion.fr>
Cc: Alex Deucher <alexander.deucher@amd.com>
Cc: Harry Wentland <hwentlan@amd.com>
Cc: Nicholas Kazlauskas <nicholas.kazlauskas@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
---
 drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
index dbbe304327f4..4ee747a6f916 100644
--- a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
@@ -8981,6 +8981,11 @@ static int dm_update_plane_state(struct dc *dc,
 			return -EINVAL;
 		}
 
+		if (new_plane_state->src_x != 0 || new_plane_state->src_y != 0) {
+			DRM_DEBUG_ATOMIC("Cropping not supported for cursor plane\n");
+			return -EINVAL;
+		}
+
 		if (new_plane_state->fb) {
 			if (new_plane_state->fb->width > new_acrtc->max_cursor_width ||
 			    new_plane_state->fb->height > new_acrtc->max_cursor_height) {
@@ -8989,6 +8994,11 @@ static int dm_update_plane_state(struct dc *dc,
 						 new_plane_state->fb->height);
 				return -EINVAL;
 			}
+			if (new_plane_state->src_w != new_plane_state->fb->width << 16 ||
+			    new_plane_state->src_h != new_plane_state->fb->height << 16) {
+				DRM_DEBUG_ATOMIC("Cropping not supported for cursor plane\n");
+				return -EINVAL;
+			}
 
 			switch (new_plane_state->fb->width) {
 			case 64:
-- 
2.25.1

